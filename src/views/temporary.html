<html lang="en">
<head>
    <title>My Page</title>
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0-alpha.6/css/bootstrap.min.css" integrity="sha384-rwoIResjU2yc3z8GV/NPeZWAv56rSmLldC3R/AZzGRnGxQQKnKkoFVhFQhNUwEyJ" crossorigin="anonymous">
    <script src="https://code.jquery.com/jquery-3.1.1.slim.min.js" integrity="sha384-A7FZj7v+d/sdmMqp/nOQwliLvUsJfDHW+k9Omg/a/EheAdgtzNs3hpfag6Ed950n" crossorigin="anonymous"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tether/1.4.0/js/tether.min.js" integrity="sha384-DztdAPBWPRXSA/3eYEEUWrWCy7G5KFbe8fFjk5JAIxUYHKkDx6Qin1DkWx51bBrb" crossorigin="anonymous"></script>
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0-alpha.6/js/bootstrap.min.js" integrity="sha384-vBWWzlZJ8ea9aCX4pEW3rVHjgjt7zpkNpZk+02D9phzyeVkE+jo0ieGizqPLForn" crossorigin="anonymous"></script>
    <link rel="stylesheet" type="text/css" href="../styles/styles.css">

    <!-- fonts -->
    <link href="http://maxcdn.bootstrapcdn.com/font-awesome/4.2.0/css/font-awesome.min.css" rel="stylesheet" />
</head>

<body>
    <nav class="navbar navbar-toggleable-md navbar-light bg-faded">
        <button class="navbar-toggler navbar-toggler-right" type="button" data-toggle="collapse" data-target="#navbarSupportedContent" aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
            <span class="navbar-toggler-icon"></span>
        </button>
        <a class="navbar-brand" href="#">NegotiateHER</a>

        <div class="collapse navbar-collapse" id="navbarSupportedContent">
            <ul class="navbar-nav mr-auto">
                <li class="nav-item active">
                    <a class="nav-link" href="#">AI Stuff<span class="sr-only">(current)</span></a>
                </li>

                <li class="nav-item">
                    <a class="nav-link" href="#">More Page</a>
                </li>
            </ul>
        </div>
    </nav>


    <div class="jumbotron" id="main-header">
        <h1>More $$$ Plz...</h1>
    </div>

    <div class="container" id="content">

        <div class="text-center">
            <div>
                <img src="https://i.pinimg.com/736x/93/20/d3/9320d30ef682c0f797df0d9f2be82ab5--facebook.jpg">
            </div>

            <div>
                <!--<input type="button" value="START" class="btn btn-primary" id="mic">-->
                <img src="https://findicons.com/files/icons/1580/devine_icons_part_2/128/mic.png" id="mic">
            </div>

            <input type="button" value="STOP" class="btn btn-danger">


            <p>Press Space Bar to Start Speaking!</p>
        </div>

    </div>

    <div id="warning">
        <h1 style="font-weight:500;">Speech Recognition SDK not found.</h1>
        <h2 style="font-weight:500;">Please execute <code>npm run bundle</code> and reload.</h2>
    </div>

    <div class="container">
        <textarea id="phraseDiv">

        </textarea>
    </div>

    <!-- SDK REFERENCE -->
    <script src="../../azure-speech-web-sdk/distrib/speech.sdk.bundle.js"></script>


    <!-- SDK USAGE -->
    <script>
        const subscriptionKey = '2823454f4bf3464d891d5b4cf285445f';
        // On document load resolve the SDK dependency
        function Initialize(onComplete) {
            if (!!window.SDK) {
                document.getElementById('content').style.display = 'block';
                document.getElementById('warning').style.display = 'none';
                onComplete(window.SDK);
            }
        }

        // Setup the recognizer
        function RecognizerSetup(SDK) {

            let recognitionMode = SDK.RecognitionMode.Interactive;

            var recognizerConfig = new SDK.RecognizerConfig(
                new SDK.SpeechConfig(
                    new SDK.Context(
                        new SDK.OS(navigator.userAgent, "Browser", null),
                        new SDK.Device("SpeechSample", "SpeechSample", "1.0.00000"))),
                recognitionMode,
                'en-us', // Supported languages are specific to each recognition mode. Refer to docs.
                SDK.SpeechResultFormat.Simple); // SDK.SpeechResultFormat.Simple (Options - Simple/Detailed)


            var useTokenAuth = false;

            var authentication = function() {
                if (!useTokenAuth)
                    return new SDK.CognitiveSubscriptionKeyAuthentication(subscriptionKey);

                var callback = function() {
                    var tokenDeferral = new SDK.Deferred();
                    try {
                        var xhr = new(XMLHttpRequest || ActiveXObject)('MSXML2.XMLHTTP.3.0');
                        xhr.open('GET', '/token', 1);
                        xhr.onload = function () {
                            if (xhr.status === 200)  {
                                tokenDeferral.Resolve(xhr.responseText);
                            } else {
                                tokenDeferral.Reject('Issue token request failed.');
                            }
                        };
                        xhr.send();
                    } catch (e) {
                        window.console && console.log(e);
                        tokenDeferral.Reject(e.message);
                    }
                    return tokenDeferral.Promise();
                }

                return new SDK.CognitiveTokenAuthentication(callback, callback);
            }();

            return SDK.CreateRecognizer(recognizerConfig, authentication);


        }

        // Start the recognition
        function RecognizerStart(SDK, recognizer) {
            recognizer.Recognize((event) => {
                /*
                 Alternative syntax for typescript devs.
                 if (event instanceof SDK.RecognitionTriggeredEvent)
                */
                switch (event.Name) {
                    case "RecognitionTriggeredEvent" :
                        console.log("Initializing");
                        break;
                    case "ListeningStartedEvent" :
                        console.log("Listening");
                        break;
                    case "RecognitionStartedEvent" :
                        console.log("Listening_Recognizing");
                        break;
                    case "SpeechStartDetectedEvent" :
                        console.log("Listening_DetectedSpeech_Recognizing");
                        console.log(JSON.stringify(event.Result)); // check console for other information in result
                        break;
                    case "SpeechHypothesisEvent" :
                        //UpdateRecognizedHypothesis(event.Result.Text, false);
                        console.log(JSON.stringify(event.Result)); // check console for other information in result
                        break;
                    case "SpeechFragmentEvent" :
                        //UpdateRecognizedHypothesis(event.Result.Text, true);
                        console.log(JSON.stringify(event.Result)); // check console for other information in result
                        break;
                    case "SpeechEndDetectedEvent" :
                        OnSpeechEndDetected();
                        console.log("Processing_Adding_Final_Touches");
                        console.log(JSON.stringify(event.Result)); // check console for other information in result
                        break;
                    case "SpeechSimplePhraseEvent" :
                        UpdateRecognizedPhrase(JSON.stringify(event.Result, null, 3));
                        break;
                    case "SpeechDetailedPhraseEvent" :
                        UpdateRecognizedPhrase(JSON.stringify(event.Result, null, 3));
                        break;
                    case "RecognitionEndedEvent" :
                        OnComplete();
                        console.log("Idle");
                        console.log(JSON.stringify(event)); // Debug information
                        break;
                    default:
                        console.log(JSON.stringify(event)); // Debug information
                }
            })
                .On(() => {
                        // The request succeeded. Nothing to do here.
                    },
                    (error) => {
                        console.error(error);
                    });
        }

        // Stop the Recognition.
        function RecognizerStop(SDK, recognizer) {
            // recognizer.AudioSource.Detach(audioNodeId) can be also used here. (audioNodeId is part of ListeningStartedEvent)
            recognizer.AudioSource.TurnOff();
        }
    </script>



    <script>
        var mic, stopBtn, phraseDiv;

        const KEY = '2823454f4bf3464d891d5b4cf285445f';

        var SDK;
        var recognizer;

        document.addEventListener("DOMContentLoaded", function () {
            mic = document.getElementById('mic');
            stopBtn = document.getElementById('stopBtn');
            phraseDiv = document.getElementById("phraseDiv");

            mic.addEventListener('click', function() {
                if (KEY === null) {
                    alert('subscription key needed!');
                } else {
                    if (!recognizer) {
                        Setup();
                    }

                    phraseDiv.innerHTML = "";
                    RecognizerStart(SDK, recognizer);
                    //mic.disabled = true;

                }

            });

            Initialize(function (speechSdk) {
                SDK = speechSdk;
                //mic.disabled = false;
            });


        });

        function Setup() {
            if (recognizer != null) {
                RecognizerStop(SDK, recognizer);
            }
            recognizer = RecognizerSetup(SDK);
            console.log(recognizer)
        }


        function OnSpeechEndDetected() {
            //stopBtn.disabled = true;
            console.log('end detected')
        }

        function UpdateRecognizedPhrase(json) {
            phraseDiv.innerHTML += json + "\n";
        }

        function OnComplete() {
            //mic.disabled = false;
            stopBtn.disabled = true;
        }

    </script>


</body>
</html>
